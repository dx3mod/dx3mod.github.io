---
title: Исследуем формат RPM файлов
publish_date: 2024-03-28
description: Краткий и неточный пересказ спецификации. 
tags: ["linux", "rpm"]
---

Не так давно я [*завершил*](https://jsr.io/@dx3mod/rpm-parser) написание парсера RPM пакетов для одного своего следующего проекта, поэтому хотел поделиться обо всём этом.

RPM, он же [RPM Package Manager](https://ru.wikipedia.org/wiki/RPM) и он же формат пакетов ПО во всяких *энтерпрайзных* дистрибутивах Linux и не только. Он вполне хорошо [задокументирован](https://refspecs.linuxbase.org/LSB_4.1.0/LSB-Core-generic/LSB-Core-generic/pkgformat.html) (в отличие от всяких *мастдайных дебианов*). 

Поэтому моя статья больше про краткий и неточный пересказ спецификации.

## Формат

RPM-пакет - это файл, содержащий в себе метаинформацию (информацию о самом себе) и непосредственно архив (зачастую в формате [cpio](https://ru.wikipedia.org/wiki/Cpio)) с файлами.

<img src="/public/media/research_rpm_file_format/global-format.svg" align="center" width="25%">

Метаинформация идёт в самом начале файла и представляет из себя три секции:

1. Ведущую (aka Lead)
2. Сигнатуру (aka Signature)
3. Заголовок (aka Header)


<!-- ![](../media/research_rpm_file_format/global-format.svg) -->

Все данные выровнены и идут в порядке [big-endian](https://ru.wikipedia.org/wiki/%D0%9F%D0%BE%D1%80%D1%8F%D0%B4%D0%BE%D0%BA_%D0%B1%D0%B0%D0%B9%D1%82%D0%BE%D0%B2). 

### Секция Lead

<img src="/public/media/research_rpm_file_format/lead.svg" align="center" width="50%">


##### Magic bytes

Начинается с четырёх магических байтов `ed ab ee db`, обозначающих, что перед нами RPM-пакет. 

Собственно, вы можете сами всё посмотреть, воспользовавшись [hex-редактором](https://hexed.it/).

##### Package Format Version

После чего идут два байте, указывающих версию формата пакета. Первый байт это мажорная (major) версия, второй - минорная (minor).
```js
03 00
```
То есть `03 00` это версия `3.0`, что актуальна на данный момент (хотя есть и четвёртая версия).

##### Type

Далее двухбайтное поле, содержащие информацию о типе пакета:

- Бинарный (`00 00`) - пакет с компилированными файлами, готовыми к установке.
- *Source* (`00 01`) - пакет с исходными кодами.

##### Arch 

По изначальной задумки тут должна была быть закодирована архитектура, под которую собран пакет, но эта идея устарела aka deprecated. 

Двухбайтное поле.

##### Package filename 

Строка до 66 символов (байт). Содержит название *файла пакета*: `<имя>-<версию>-<дистрибутив>.rpm`. 

##### OS

Двухбайтное поле кода операционной системы. Устарело.  

Должно быть равно `00 01`.

##### Signature Type

Двухбайтное поле, указующее тип секции сигнатуры. 

Должное быть равно `00 05`. 

#### Пример

![](https://i.ibb.co/YhGX93B/image.png)


### Сигнатура и заголовок

Секции signature и header имеют одинаковую структуру (будем называть её *заголовком*). По факту они являются просто реализацией [ассоциативного массива][ascoarr] с записями *ключ-значение*, в которых и содержится всё самое интересное. 

Если вы знакомы с бинарными форматами сериализации, типа [BSON](https://ru.wikipedia.org/wiki/BSON), то принцип тут тот же (нуууу почти).

<img src="/public/media/research_rpm_file_format/global-header.svg" align="center" width="25%">

Заголовок состоит из трёх частей:
1. Индекса (Index)
2. Массива записей (Entries) - N-ое количество *записей* (entry)
3. Данных (data) - тут хранятся значения  *записей*

#### Index

<img src="/public/media/research_rpm_file_format/header-index.svg" align="center" width="55%">


Заголовок также начинается с четырёх магических байт. А после содержит только два важных поля: количество записей и размер секции данных. 

Пример:
```
                      reserved          размер секции данных
                    v---------v             v---------v
        8E AD E8 01 00 00 00 00 00 00 00 04 00 00 00 50

        ^---------^             ^---------^
         magic code            кол-во записей
```

*На самом деле четвёртый байт (`01`) обозначает версию, но оно фиксировано, поэтому можно считать за магическое число.*

#### Entries

<img src="/public/media/research_rpm_file_format/header-entries.svg" align="center" width="55%">


В части Entries находится массив из *записей*. Количество элементов равно полю *количество записей* из индекса.

##### Запись

<img src="/public/media/research_rpm_file_format/header-entry.svg" align="center" width="55%">

Запись это структура, описывающая данные, находящиеся в части `data`. 

Запись состоит из:
1. Тега - он же ключ в ассоциативном массиве
2. Типа - тип значения записи (число, строка, массив строк и т.д.)
3. Смещения - относительно начала части data
4. Количества - сколько таких элементов

Пример записи:
```
                       type                    count
                    v---------v             v---------v
        00 00 00 3E 00 00 00 07 00 00 00 40 00 00 00 10
        ^---------^             ^---------^
            tag                    offset
```
```js
{
    tag: 0x3E,
    type: "bin",
    offset: 0x40,
    count: 0x10
}
```

#### data

После разбора всех записей мы можем считать данные, на которые они указывают. 

Например, для предыдущего примера:
```js
buffer.offset = data_part_offset + entry.offset;
buffer.readBytes(entry.count);
```

#### Выравнивание 

После секции сигнатуры обязательно должно идти выравнивание! Нужный padding можно вычислить по формуле: `padding = (8 - (sectionSize % 8)) % 8`.

### Секция payload

Финальная секция и самая важная - тут находятся *полезная нагрузка*. Размер секции указывается в сигнатуре под тегом `1000`.

Обычно тут находится сжатый cpio-архив. Но фактически это описывается в заголовке: под тегом `1124` формат архива, под `1125` алгоритм сжатия и т.д.

## Ссылки 

- [Package File Format](https://refspecs.linuxbase.org/LSB_4.1.0/LSB-Core-generic/LSB-Core-generic/pkgformat.html)
- Мой [rpm-parser](https://jsr.io/@dx3mod/rpm-parser/)
- Референс реализация [rpm-rs/rpm](https://github.com/rpm-rs/rpm/), на которую я опирался

<!-- ## Итого

Как вы видите, формат относительно простой. Черновой вариант парсера пишется вечером за пару часов. -->

[ascoarr]: https://ru.wikipedia.org/wiki/%D0%90%D1%81%D1%81%D0%BE%D1%86%D0%B8%D0%B0%D1%82%D0%B8%D0%B2%D0%BD%D1%8B%D0%B9_%D0%BC%D0%B0%D1%81%D1%81%D0%B8%D0%B2
